---
title: "linear_models"
author: "Ayeshra Acharya"
date: "11/23/2020"
output: html_document
---

Lm is linear models, glm for generalized lnear models
Arguments include: formula, data
Output is complex and kind of messy, use broom package!
- Use broom after running LM 

```{r setup, include = FALSE}
library(tidyverse)
library(p8105.datasets)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)
```
```{r}
data("nyc_airbnb")
nyc_airbnb = 
  nyc_airbnb %>% 
  mutate(stars = review_scores_location / 2) %>% 
  rename(
    borough = neighbourhood_group,
    neighborhood = neighbourhood) %>% 
  filter(borough != "Staten Island") %>% 
  select(price, stars, borough, neighborhood, room_type)
```

## Fit a model. We want to know what is the price of an an airbnb rental and how is it related to star (numeric predictor) and borough(categorical predictor). Fir some line that runs through stars and maybe different for each borough. 
```{r}
nyc_airbnb %>%
  ggplot(aes(x = stars,y=price,color=borough)) + 
  geom_point()
```
Let's fit the model we care about. Linear model relating price to starts to borough. 
```{r}
fit = lm(price ~ stars + borough, data = nyc_airbnb)
```

Let's look at the result.. If you look at the summary you get way more, R squared, residuals etc. You can also get coefficients of the fit. There has been useful stuff that R has produced using "fit", but it is not great. So we will use broom! 

```{r}
broom::glance(fit)
```
Here, we get the r-squared, we get p-value etc. This is some of the most relevant info. Global test p-value. 

However, this below might be better. 
```{r}
broom::tidy(fit)
``` 
This above is showing us: intercept, coefficient for stars, brooklyn to reference group, manhattan to reference group and queens to reference group. 
How to interpret: One unit increase in stars, I expect the price to go up 32 dollars, keeping the borough fixed.
Brooklyn room airbnb is 40 dollars more expensive than Bronx. Manhattan is 90 dollars more expensive, Queens is 13 dollars more expensive. 
We can see p value and assess significance. 
- Remember, this is a data frame. If we aren't interested in certain things, 
we can omit. For example:
```{r}
broom::tidy(fit) %>%
  select(-std.error,-statistic) %>%
  mutate(
    term = str_replace(term,"borough","Borough:")
  ) %>%
  knitr::kable()
``` 
## Be in control of factors.
For example, borough is a character variable. Very often, this gets converted into a factor variable. You perserve text, but add another string... Idk but basically, Bronx is being used as the reference here. 
- But what if, I want to make reference category the most common one? SO, I want reference group to be the one that has the most airbnb rentals. I want room type to be treated as factor variable, not alphabetical but most common .
Mutate so that borough is factor and we are putting it in order of frequency of borough. 

```{r}
nyc_airbnb = 
  nyc_airbnb %>%
  mutate(
    borough = fct_infreq(borough), 
    room_type = fct_infreq(room_type)
  )
```

Now, let's look at the plot again. 
```{r}
nyc_airbnb %>%
  ggplot(aes(x=stars,y=price, color=borough)) +
  geom_point()
``` 
It is very similar, but the ordering on axis has changed. Borough is in order of frequency of these things. 

## Re fit the model 
```{r}

fit = lm(price ~ stars + borough, data = nyc_airbnb)
broom::tidy(fit)

``` 

The difference now is that manhattan became the reference group and everythig else is being compared to it. We didn't change model in a fundamental way, we changed the reference group. 

## Diagnostics 
```{r}
residuals(fit)
```
Up until now we have been using the above approach. We get super long vector. we want to get all variables and then tack onto that fitted variables that go along with it. So we will take advantage of modelr package. 
```{r}
modelr::add_residuals(nyc_airbnb,fit)
``` 
This dataset has a column for residual value. Residuals based on model fit. We can look at distributions of residuals, for instance. 
```{r}
nyc_airbnb %>%
  modelr::add_residuals(fit) %>%
  ggplot(aes(x=borough,y=resid)) + 
  geom_violin() + 
  ylim(-500,1500)

nyc_airbnb %>%
  modelr::add_residuals(fit) %>%
  ggplot(aes(x=stars,y=resid)) +
  geom_point() + 
  facet_wrap(.~ borough)
``` 
What is this telling us?? 
In Manhattan, as we get to higher star values, residuals get wider distributions. 4 5 stars in Manhattan, distribution of residuals in Manhattan gets higher. Same in Brooklyn. 
Why does Queens have one outlier?? 
Bronx doesn't have this issue 




